<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>calculator.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-calculator.html">calculator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-calculator.html#.getChance">getChance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-calculator.html#.getSumInDeck">getSumInDeck</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-calculator.html#.getSumRequired">getSumRequired</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-math.html">math</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-math.html#.choose">choose</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-math.html#.createPascalTriangle">createPascalTriangle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-math.html#.powerset">powerset</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="index_.html">index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="index_.html#.addRow">addRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="index_.html#.deleteRow">deleteRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="index_.html#.getData">getData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="index_.html#.handle">handle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="index_.html#.init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="index_.html#.setData">setData</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">calculator.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Calculator module.
 *
 * @module calculator
 */
import _ from 'lodash';
import * as math from './math';

const MAX_N = 26;                 // Maximum length of a power set is 2^MAX_N
const MONTE_CARLO_TRIALS = 10000; // Number of trials to use for Monte Carlo simulation

/**
 * Get sum of "Amount Required" values in the table.
 *
 * @param {Data} data Form data
 * @returns {number} The sum
 */
export function getSumRequired (data) {
  return _.reduce(data.cards, (acc, card) => acc + card.numRequired, 0);
}

/**
 * Get sum of "Amount in Deck" values in the table.
 *
 * @param {Data} data Form data
 * @returns {number} The sum
 */
export function getSumInDeck (data) {
  return _.reduce(data.cards, (acc, card) => acc + card.numInDeck, 0);
}

/**
 * Compute the chance of the combo (given by form data). Accounts for the possibility of having more than required.
 *
 * @param {Data} data Form data
 * @return {Chance} The chance
 */
export function getChance (data) {
  // Obtain required data
  let prob = 0;
  const freeCards = data.handSize - getSumRequired(data);

  // Compute chance
  const tmpCards = JSON.stringify(data.cards);
  try {
    // Each node points back to a card
    const nodes = [];
    for (let i = 0; i &lt; data.cards.length; i++) {
      const card = data.cards[i];
      for (let j = 0; j &lt; card.numInDeck - card.numRequired; j++) {
        nodes.push(i);
      }
    }

    // Monte Carlo if computation would be too expensive
    if (nodes.length > MAX_N &amp;&amp; freeCards > 1) {
      return {
        percent: getChance3(data) * 100,
        experimental: true
      };
    }

    // Compute power set of nodes, but only keep elements of n &lt;= freeCards
    const ps = math.powerset(nodes, freeCards);

    // Loop through power set
    for (let k = 0; k &lt; ps.length; k++) {
      const nodeArr = ps[k];
      for (let l = 0; l &lt; nodeArr.length; l++) {
        // For each node, add one to its 'numRequired' value
        data.cards[nodeArr[l]].numRequired++;
      }
      prob += getChance2(data);
      data.cards = JSON.parse(tmpCards); // Reset cards
    }
  } finally {
    data.cards = JSON.parse(tmpCards);
  }

  // Get chance
  const chance = {
    percent: prob * 100,
    experimental: false
  };

  // Return it
  const percent = chance.percent;
  const experimental = chance.experimental;
  if (percent >= 99.9 &amp;&amp; percent &lt; 100) {
    return {
      percent: 99.9,
      experimental: experimental
    }; // Avoid rounding to 100
  } else {
    return {
      percent: percent,
      experimental: experimental
    };
  }
}

/**
 * Compute the chance of the given combo, with EXACT amount required (no more, no less).
 *
 * @param {Data} data Form data
 * @return {number} Probability in decimal form
 * @private
 */
function getChance2 (data) {
  // Use multivariate hypergeometric formula to compute chance
  const num = _.reduce(data.cards, (acc, card) => {
    return acc * math.choose(card.numInDeck, card.numRequired);
  }, math.choose(data.deckSize - getSumInDeck(data), data.handSize - getSumRequired(data)));
  const den = math.choose(data.deckSize, data.handSize);
  return num / den;
}

/**
 * Compute the chance of the given combo using Monte Carlo method. (Used if standard computation would require
 * an extraordinarily large power set.)
 *
 * @param {Data} data Form data
 * @return {number} Probability in decimal form
 * @private
 */
function getChance3 (data) {
  // Define variables
  let successes = 0;
  const deck = [];
  const requiredHand = [];

  _.forEach(data.cards, card => {
    for (let i = 0; i &lt; card.numInDeck; i++) {
      deck.push(card);
    }

    for (let j = 0; j &lt; card.numRequired; j++) {
      requiredHand.push(card);
    }
  });

  for (let i = 0, len = deck.length; i &lt; data.deckSize - len; i++) {
    deck.push({});
  }
  for (let j = 0; j &lt; MONTE_CARLO_TRIALS; j++) {
    const hand = _.shuffle(deck).slice(0, data.handSize);
    if (_.difference(requiredHand, hand).length === 0) {
      successes++;
    }
  }

  return successes / MONTE_CARLO_TRIALS;
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
